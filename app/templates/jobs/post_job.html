{% extends "base.html" %}
{% block title %}Đăng tin tuyển dụng{% endblock %}

{% block content %}
<div class="w-full max-w-4xl mx-auto py-8 sm:py-12">
  <div class="bg-[var(--primary-blue)] text-white rounded-xl shadow-lg p-6 mb-8">
    <div class="flex items-center gap-4">
      <div class="w-12 h-12 bg-white rounded-xl flex items-center justify-center">
        <span class="text-2xl font-bold text-[var(--primary-blue)]">JN</span>
      </div>
      <div>
        <h1 class="text-2xl sm:text-3xl font-extrabold">Đăng tin tuyển dụng</h1>
        <p class="text-white/90 text-sm">Điền đầy đủ thông tin để tin tuyển dụng tiếp cận ứng viên phù hợp.</p>
      </div>
    </div>
  </div>

  <div class="bg-white rounded-xl p-8">
    <a href="{{ url_for('employer.dashboard') }}" class="inline-flex items-center text-gray-500 hover:text-gray-700 mb-6">
      <i class="fas fa-chevron-left mr-2"></i> Quay lại
    </a>

    <form method="POST" action="{{ url_for('job.post_job') }}" class="space-y-6" novalidate>
      {{ form.hidden_tag() }}

      {# Hidden / meta fields #}
      {% if form.employer_id is defined %}
        {{ form.employer_id(type="hidden", id="employer_id") }}
      {% else %}
        <input type="hidden" id="employer_id" name="employer_id" value="">
      {% endif %}

      {% if form.created_at is defined %}
        {{ form.created_at(type="hidden", id="created_at") }}
      {% else %}
        <input type="hidden" id="created_at" name="created_at" value="">
      {% endif %}

      {% if form.updated_at is defined %}
        {{ form.updated_at(type="hidden", id="updated_at") }}
      {% else %}
        <input type="hidden" id="updated_at" name="updated_at" value="">
      {% endif %}

      {% if form.latitude is defined %}
        {{ form.latitude(id="latitude", class="hidden") }}
      {% else %}
        <input type="hidden" id="latitude" name="latitude" value="">
      {% endif %}

      {% if form.longitude is defined %}
        {{ form.longitude(id="longitude", class="hidden") }}
      {% else %}
        <input type="hidden" id="longitude" name="longitude" value="">
      {% endif %}

      <!-- title -->
      <div>
        <label for="title" class="block text-2sm font-semibold text-gray-700 mb-1">Tiêu đề</label>
        {% if form.title is defined %}
          {{ form.title(id="title", class="w-full px-4 py-2 border border-gray-200 rounded-lg") }}
        {% else %}
          <input id="title" name="title" class="w-full px-4 py-2 border border-gray-200 rounded-lg" />
        {% endif %}
        {% if form.title is defined and form.title.errors %}
          <div class="text-red-500 text-xs mt-1">
            {% for e in form.title.errors %}{{ e }}{% endfor %}
          </div>
        {% endif %}
      </div>

      <!-- description -->
      <div>
        <label for="description" class="block text-2sm font-semibold text-gray-700 mb-1">Mô tả công việc</label>
        {% if form.description is defined %}
          {{ form.description(id="description", rows="6", class="w-full px-4 py-2 border border-gray-200 rounded-lg") }}
        {% else %}
          <textarea id="description" name="description" rows="6" class="w-full px-4 py-2 border border-gray-200 rounded-lg"></textarea>
        {% endif %}
        {% if form.description is defined and form.description.errors %}
          <div class="text-red-500 text-xs mt-1">
            {% for e in form.description.errors %}{{ e }}{% endfor %}
          </div>
        {% endif %}
      </div>

      <!-- requirements -->
      <div>
        <label for="requirements-input" class="block text-2sm font-semibold text-gray-700 mb-1">Yêu cầu</label>
        <p class="text-sm text-medium text-gray-500 mb-2">(Phân tách bằng , hoặc ;)</p>
        {% if form.requirements is defined %}
          {{ form.requirements(id="requirements-input", class="w-full px-4 py-2 border border-gray-200 rounded-lg", placeholder="Ví dụ: Kinh nghiệm 2 năm, Biết Python") }}
        {% else %}
          <textarea id="requirements-input" name="requirements" class="w-full px-4 py-2 border border-gray-200 rounded-lg" placeholder="Ví dụ: Kinh nghiệm 2 năm, Biết Python"></textarea>
        {% endif %}
        <div id="requirements-preview" class="flex flex-wrap gap-2 mt-3"></div>
        {% if form.requirements is defined and form.requirements.errors %}
          <div class="text-red-500 text-xs mt-1">
            {% for e in form.requirements.errors %}{{ e }}{% endfor %}
          </div>
        {% endif %}
      </div>

      <!-- benefits (bullet list) -->
      <div>
        <label for="benefits-input" class="block text-2sm font-semibold text-gray-700 mb-1">Quyền lợi</label>
        <p class="text-sm text-medium text-gray-500 mb-2">(Phân tách bằng , hoặc ;)</p>
        {% if form.benefits is defined %}
          {{ form.benefits(id="benefits-input", class="w-full px-4 py-2 border border-gray-200 rounded-lg", placeholder="Ví dụ: Lương cạnh tranh, Thưởng lễ Tết") }}
        {% else %}
          <textarea id="benefits-input" name="benefits" class="w-full px-4 py-2 border border-gray-200 rounded-lg" placeholder="Ví dụ: Lương cạnh tranh, Thưởng lễ Tết"></textarea>
        {% endif %}
        <ul id="benefits-preview" class="list-disc list-inside mt-2 text-sm text-gray-700"></ul>
        {% if form.benefits is defined and form.benefits.errors %}
          <div class="text-red-500 text-xs mt-1">
            {% for e in form.benefits.errors %}{{ e }}{% endfor %}
          </div>
        {% endif %}
      </div>

      <!-- job_type, remote_option -->
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
        <div>
          <label for="job_type" class="block text-2sm font-semibold text-gray-700 mb-1">Loại công việc</label>
          {% if form.job_type is defined %}
            {{ form.job_type(id="job_type", class="w-full px-4 py-2 border border-gray-200 rounded-lg") }}
          {% else %}
            <select id="job_type" name="job_type" class="w-full px-4 py-2 border border-gray-200 rounded-lg">
              <option value="">-- Chọn --</option>
              <option value="Full-time">Full-time</option>
              <option value="Part-time">Part-time</option>
              <option value="Internship">Internship</option>
              <option value="Remote">Remote</option>
            </select>
          {% endif %}
        </div>

        <div>
          <label for="remote_option" class="block text-2sm font-semibold text-gray-700 mb-1">Hình thức</label>
          {% if form.remote_option is defined %}
            {{ form.remote_option(id="remote_option", class="w-full px-4 py-2 border border-gray-200 rounded-lg") }}
          {% else %}
            <select id="remote_option" name="remote_option" class="w-full px-4 py-2 border border-gray-200 rounded-lg">
              <option value="">-- Chọn --</option>
              <option value="Onsite">Onsite</option>
              <option value="Remote">Remote</option>
              <option value="Hybrid">Hybrid</option>
            </select>
          {% endif %}
        </div>
      </div>

      <!-- salary_min, salary_max, currency -->
      <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
        <div>
          <label for="salary_min" class="block text-2sm font-semibold text-gray-700 mb-1">Lương tối thiểu</label>
          <input id="salary_min" name="salary_min" type="text" inputmode="numeric"
                 class="w-full px-4 py-2 border border-gray-200 rounded-lg"
                 value="{{ form.salary_min.data if form.salary_min is defined and form.salary_min.data is not none else '' }}">
          {% if form.salary_min is defined and form.salary_min.errors %}
            <div class="text-red-500 text-xs mt-1">
              {% for e in form.salary_min.errors %}{{ e }}{% endfor %}
            </div>
          {% endif %}
        </div>

        <div>
          <label for="salary_max" class="block text-2sm font-semibold text-gray-700 mb-1">Lương tối đa</label>
          <input id="salary_max" name="salary_max" type="text" inputmode="numeric"
                 class="w-full px-4 py-2 border border-gray-200 rounded-lg"
                 value="{{ form.salary_max.data if form.salary_max is defined and form.salary_max.data is not none else '' }}">
          {% if form.salary_max is defined and form.salary_max.errors %}
            <div class="text-red-500 text-xs mt-1">
              {% for e in form.salary_max.errors %}{{ e }}{% endfor %}
            </div>
          {% endif %}
        </div>

        <div>
          <label for="currency" class="block text-2sm font-semibold text-gray-700 mb-1">Đơn vị</label>
          {% if form.currency is defined %}
            {{ form.currency(id="currency", class="w-full px-4 py-2 border border-gray-200 rounded-lg") }}
          {% else %}
            <input id="currency" name="currency" class="w-full px-4 py-2 border border-gray-200 rounded-lg" value="VND">
          {% endif %}
        </div>
      </div>

      <!-- location: city, district, street_address -->
      <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
        <div>
          <label for="city-select" class="block text-2sm font-semibold text-gray-700 mb-1">Thành phố / Tỉnh</label>
          <select id="city-select" name="city" class="w-full px-4 py-2 border border-gray-200 rounded-lg" aria-label="Thành phố">
            <option value="">Đang tải danh sách...</option>
          </select>
          {% if form.city is defined and form.city.errors %}
            <div class="text-red-500 text-xs mt-1">
              {% for e in form.city.errors %}{{ e }}{% endfor %}
            </div>
          {% endif %}
        </div>

        <div>
          <label for="district" class="block text-2sm font-semibold text-gray-700 mb-1">Quận/Huyện</label>
          {% if form.district is defined %}
            {{ form.district(id="district", class="w-full px-4 py-2 border border-gray-200 rounded-lg", placeholder="Nhập quận/huyện") }}
          {% else %}
            <input id="district" name="district" class="w-full px-4 py-2 border border-gray-200 rounded-lg" placeholder="Nhập quận/huyện" />
          {% endif %}
        </div>

        <div>
          <label for="street_address" class="block text-2sm font-semibold text-gray-700 mb-1">Địa chỉ cụ thể</label>
          {% if form.street_address is defined %}
            {{ form.street_address(id="street_address", class="w-full px-4 py-2 border border-gray-200 rounded-lg", placeholder="Nhập địa chỉ cụ thể") }}
          {% else %}
            <input id="street_address" name="street_address" class="w-full px-4 py-2 border border-gray-200 rounded-lg" placeholder="Nhập địa chỉ cụ thể" />
          {% endif %}
        </div>
      </div>

      <!-- work times and days -->
      <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
        <div>
          <label for="work_start_time" class="block text-2sm font-semibold text-gray-700 mb-1">Giờ bắt đầu</label>
          {% if form.work_start_time is defined %}
            {{ form.work_start_time(id="work_start_time", class="w-full px-4 py-2 border border-gray-200 rounded-lg") }}
          {% else %}
            <input id="work_start_time" name="work_start_time" type="time" class="w-full px-4 py-2 border border-gray-200 rounded-lg">
          {% endif %}
        </div>

        <div>
          <label for="work_end_time" class="block text-2sm font-semibold text-gray-700 mb-1">Giờ kết thúc</label>
          {% if form.work_end_time is defined %}
            {{ form.work_end_time(id="work_end_time", class="w-full px-4 py-2 border border-gray-200 rounded-lg") }}
          {% else %}
            <input id="work_end_time" name="work_end_time" type="time" class="w-full px-4 py-2 border border-gray-200 rounded-lg">
          {% endif %}
        </div>

        <div>
          <label for="working_days" class="block text-2sm font-semibold text-gray-700 mb-1">Ngày làm việc</label>
          {% if form.working_days is defined %}
            {{ form.working_days(id="working_days", class="w-full px-4 py-2 border border-gray-200 rounded-lg", placeholder="VD: Thứ 2 - Thứ 6") }}
          {% else %}
            <input id="working_days" name="working_days" class="w-full px-4 py-2 border border-gray-200 rounded-lg" placeholder="VD: Thứ 2 - Thứ 6" />
          {% endif %}
        </div>
      </div>

      <!-- deadline, interview_date -->
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
        <div>
          <label for="deadline" class="block text-2sm font-semibold text-gray-700 mb-1">Hạn nộp</label>
          {% if form.deadline is defined %}
            {{ form.deadline(id="deadline", class="w-full px-4 py-2 border border-gray-200 rounded-lg") }}
          {% else %}
            <input id="deadline" name="deadline" type="date" class="w-full px-4 py-2 border border-gray-200 rounded-lg">
          {% endif %}
        </div>
        <div>
          <label for="interview_date" class="block text-2sm font-semibold text-gray-700 mb-1">Ngày phỏng vấn</label>
          {% if form.interview_date is defined %}
            {{ form.interview_date(id="interview_date", class="w-full px-4 py-2 border border-gray-200 rounded-lg") }}
          {% else %}
            <input id="interview_date" name="interview_date" type="date" class="w-full px-4 py-2 border border-gray-200 rounded-lg">
          {% endif %}
        </div>
      </div>

      <!-- Submit -->
      <div>
        {% if form.submit is defined %}
          {{ form.submit(class="w-full bg-[var(--primary-blue)] text-white font-semibold py-3 rounded-lg hover:bg-[var(--primary-blue-hover)] transition-colors") }}
        {% else %}
          <button type="submit" class="w-full bg-[var(--primary-blue)] text-white font-semibold py-3 rounded-lg hover:bg-[var(--primary-blue-hover)] transition-colors">Đăng tin</button>
        {% endif %}
      </div>
    </form>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  // --- Load provinces into city-select ---
  const citySelect = document.getElementById('city-select');
  const provincesUrl = "{{ url_for('static', filename='data/provinces.json') }}";

  if (citySelect) {
    fetch(provincesUrl).then(r => {
      if (!r.ok) throw new Error('Không thể load provinces.json');
      return r.json();
    }).then(data => {
      let list = [];
      if (Array.isArray(data)) list = data;
      else if (data && Array.isArray(data.provinces)) list = data.provinces;
      else console.warn('provinces.json không đúng định dạng');

      citySelect.innerHTML = '<option value="">-- Chọn tỉnh/thành --</option>';
      const current = "{{ form.city.data if form.city is defined and form.city.data else '' }}";
      list.forEach(p => {
        const opt = document.createElement('option');
        opt.value = p;
        opt.textContent = p;
        if (current && current === p) opt.selected = true;
        citySelect.appendChild(opt);
      });
    }).catch(err => {
      console.error('Lỗi load provinces:', err);
      citySelect.innerHTML = '<option value="">(Không thể tải danh sách)</option>';
    });
  }

  // --- Utility: only digits ---
  const digitsOnly = (s) => (s || '').replace(/[^\d]/g, '');

  // --- Salary inputs: sanitize and allow free typing ---
  const salaryMin = document.getElementById('salary_min');
  const salaryMax = document.getElementById('salary_max');

  const sanitizeHandler = (e) => {
    const el = e.target;
    const before = el.value;
    const cleaned = digitsOnly(before);
    if (cleaned !== before) {
      // calculate caret position near end in a safe way
      const prevLen = before.length;
      const curPos = el.selectionStart || prevLen;
      el.value = cleaned;
      // put caret at min(curPos, cleaned.length)
      const newPos = Math.min(cleaned.length, curPos);
      el.setSelectionRange(newPos, newPos);
    }
  };

  if (salaryMin) salaryMin.addEventListener('input', sanitizeHandler);
  if (salaryMax) salaryMax.addEventListener('input', sanitizeHandler);

  // Ensure numeric-only values are submitted
  const formEl = document.querySelector('form[action$="{{ url_for("job.post_job") }}"]') || document.querySelector('form');
  if (formEl) {
    formEl.addEventListener('submit', (ev) => {
      if (salaryMin) salaryMin.value = digitsOnly(salaryMin.value);
      if (salaryMax) salaryMax.value = digitsOnly(salaryMax.value);
      // allow server-side to handle validation; client-side just sanitizes
    });
  }
});
</script>
{% endblock %}
